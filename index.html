<script src="vue.min.js"></script>
<link rel="stylesheet" href="style.css">

<div id="app" v-bind:class="darkMode ? 'dark-mode' : ''" v-on:dragover="dragover = true" v-on:dragenter="dragover = true" v-on:dragleave="dragover = false" v-on:dragend="dragover = false" v-on:drop="dragover = false; dropEvent($event)" v-bind:style="typeof taskComposer.attachment !== 'undefined' ? `background-image: linear-gradient(rgba(${darkMode?'23,27,33':'255,255,255'},0.75),rgba(${darkMode?'23,27,33':'255,255,255'},0.75)), url(${taskComposer.attachmentURL})` : ''">
    <div class="drag-overlay" v-show="dragover">Drop your image here!</div>
    <form class="composer" action="javascript:void(0)" v-on:submit="createTask(taskComposer.content, taskComposer.done, taskComposer.in_progress, taskComposer.attachment)">
        <select class="status" v-on:input="taskComposer.done = $event.target.value == 'done'; taskComposer.in_progress = $event.target.value == 'in_progress'" v-bind:style="taskComposer.done ? '' : 'background: #f39c12'">
            <option value="done">Done</option>
            <option value="">To-Do</option>
            <option value="in_progress">In Progress</option>
        </select>
        <input class="content" type="text" v-bind:placeholder="taskComposer.done ? 'Write something you did today.' : (taskComposer.in_progress ? 'Write what you\'re working on.' : 'Write a to-do.')" v-on:input="taskComposer.content = $event.target.value; autofillHashtag(); syncShadowContentScroll()" v-on:keydown="if($event.key == 'ArrowRight'){$event.target.value = taskComposer.content_autocompleted; taskComposer.content = taskComposer.content_autocompleted}; syncShadowContentScroll()" v-on:keyup="syncShadowContentScroll()" v-on:mousewheel="syncShadowContentScroll()" v-on:scroll="syncShadowContentScroll()" v-on:blur="syncShadowContentScroll()" v-on:mousemove="syncShadowContentScroll()" v-bind:style="
        `padding-left: calc(${document.querySelector('.status').getBoundingClientRect().width}px + (${getComputedStyle(document.querySelector('.status'))['margin-left']} * 2));
        padding-right: calc(${document.querySelector('.submit').getBoundingClientRect().width}px + (${getComputedStyle(document.querySelector('.submit'))['margin-right']} * 2))`">
        
        <input class="shadow-content" type="text" readonly v-on:blur="scrollLeft = $event.target.scrollLeft; setTimeout(function(){$event.target.scrollLeft = scrollLeft}, 0)" v-bind:value="taskComposer.content_autocompleted" v-bind:style="
        `padding-left: calc(${document.querySelector('.status').getBoundingClientRect().width}px + (${getComputedStyle(document.querySelector('.status'))['margin-left']} * 2));
        padding-right: calc(${document.querySelector('.submit').getBoundingClientRect().width}px + (${getComputedStyle(document.querySelector('.submit'))['margin-right']} * 2))`">
        
        <input class="attachment" type="file" v-on:input="taskComposer.attachment = $event.target.files[0]; getBase64(taskComposer.attachment).then(data => taskComposer.attachmentURL = data)">
        <button class="submit" type="submit">{{taskComposer.processing ? 'Processing...' : (typeof taskComposer.attachment !== 'undefined' ? 'Submit with image!' : 'Submit!')}}</button>
    </form>
</div>

<script>
    var electron = require('electron');
    var ipcRenderer = electron.ipcRenderer;
    
    electron.remote.getGlobal('goNormalSize')();
    
    var client_id = 'YBKDIKB3DJbyZdwkFsRCIuJscq4Xy5YNuIyAwqPG';
    var token = electron.remote.getGlobal('token');
    
    
    if(typeof token === 'undefined') {
        login();
    } else {
        setTimeout(login, 36000*100);
        checkForNewUpdate();
        setInterval(checkForNewUpdate,10*60*1000); // Every 10 minutes
        fetchHashtags();
    }
    
    ipcRenderer.on('darkModeChange', (event, arg) => {
        data.darkMode = electron.remote.getGlobal('darkMode');
    })
    
    var data = {
        dragover: false,
        darkMode: electron.remote.getGlobal('darkMode'),
        taskComposer: {
            content: '',
            content_autocompleted: '',
            done: true,
            in_progress: false,
            processing: false,
            attachment: undefined,
            attachmentURL: undefined
        },
        hashtags: []
    }
    
    var vm = new Vue({
        el: '#app',
        data: data
    });
    
    function syncShadowContentScroll() {
        document.querySelector('.shadow-content').scrollLeft = document.querySelector('.content').scrollLeft;
    }
    
    
    function createTask(content, done, in_progress, attachment) {
        data.taskComposer.processing = true;
        
        var formData = new FormData();
        formData.append('content',content);
        formData.append('done',done);
        formData.append('in_progress',in_progress);
        if(typeof attachment !== 'undefined') {
            formData.append('attachment',attachment);
        }
        
        return myFetch('https://api.getmakerlog.com/tasks/', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        }).then(r => {
            console.log(r);
            data.taskComposer.processing = false;
            data.taskComposer.content = '';
            document.querySelector('.content').value = '';
            data.taskComposer.content_autocompleted = '';
            data.taskComposer.attachment = undefined;
            data.taskComposer.attachmentURL = undefined;
            document.querySelector('.attachment').files = new FileList();
        })
    }
    
    function fetchHashtags() {
        return myFetch('https://api.getmakerlog.com/me', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        }).then(r => myFetch(`https://api.getmakerlog.com/users/${r.id}/stats`))
        .then(r => {
            data.hashtags = r.tasks_per_project.labels.filter(label => label != 'No project').sort((a,b) => r.tasks_per_project.datasets[0].data[r.tasks_per_project.labels.indexOf(b)] - r.tasks_per_project.datasets[0].data[r.tasks_per_project.labels.indexOf(a)]);
        })
    }
    
    function autofillHashtag() {
        var fullTextWithSuggestion = data.taskComposer.content;
        if((/#./).test(data.taskComposer.content)) {
            var split = data.taskComposer.content.split('#');
            var hashtagText = split[split.length - 1];
            //console.log(hashtagText);
            var possibleHashtags = data.hashtags.filter(hashtag => hashtag.startsWith(hashtagText));
            //console.log(possibleHashtags);
            var bestSuggestion = possibleHashtags[0]; // Sorted by number of times used
            //console.log(bestSuggestion);
            fullTextWithSuggestion = split;
            fullTextWithSuggestion[split.length - 1] = bestSuggestion;
            fullTextWithSuggestion = fullTextWithSuggestion.join('#');
        }
        
        //console.log(fullTextWithSuggestion);
        data.taskComposer.content_autocompleted = fullTextWithSuggestion;
    }
    
    function dropEvent(e) {
        document.querySelector('.attachment').files = e.dataTransfer.files;
    }
    
    function login() {
        document.body.innerHTML = '';
        document.body.style.background = 'linear-gradient(#000a12 60px, #ecf0f1 60px)';
        
        var storeAppHref = electron.remote.getGlobal('storeAppHref');
        storeAppHref(window.location.href);
        electron.remote.getGlobal('goFullscreen')();
        
        window.location = `https://api.getmakerlog.com/oauth/authorize/?client_id=${client_id}&scope=user:read%20tasks:write&response_type=token`;
    }
    
    function checkForNewUpdate() {
        return myFetch('https://api.github.com/repos/Booligoosh/makerlog-menubar/releases/latest')
        .then(latest => {
            var currentNum = Number(electron.remote.getGlobal('appVersion').replace(/\./g,''));
            var latestNum = Number(latest.tag_name.replace('v','').replace(/\./g,''));
            
            if(latestNum > currentNum) {
                alert(`Please update to the latest version!\nYou can download it here:\n\nhttps://github.com/Booligoosh/makerlog-menubar/releases/tag/${latest.tag_name}`);
            }
        })
    }
    
    function getBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }
    
    function myFetch(input,init = {}) {
        return fetch(input,init)
        .then(r => {
            if(r.status === 403) {
                // Credentials timed out
                login();
            } else {
                return r.headers.get('content-type').startsWith('application/json') ? r.json() : r;
            }
        }, err => {
            // No internet connection
        });
    }
    
    window.addEventListener('DOMContentLoaded', function(){vm.$forceUpdate()})
    
</script>